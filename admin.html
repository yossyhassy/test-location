<div id="login-container">
    <div class="login-card">
        <h2>管理者用 配信開始</h2>
        <input type="text" id="admin-name" placeholder="名前を入力">
        <input type="url" id="admin-icon" placeholder="アイコン画像のURL">
        <br>
        <button onclick="startAdmin()">配信を開始する</button>
    </div>
</div>

<script>
// ...中略...
let myIconUrl = "";

function startAdmin() {
    myName = document.getElementById('admin-name').value.trim();
    myIconUrl = document.getElementById('admin-icon').value.trim(); // URLを取得
    if (!myName) return alert("名前を入力してください");
    
    // アイコンが空の場合はデフォルト画像にする
    if (!myIconUrl) myIconUrl = "https://cdn-icons-png.flaticon.com/512/3135/3135715.png";

    document.getElementById('login-container').style.display = 'none';
    document.getElementById('map').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    initMap();
    startWatchdog();
}

function initMap() {
    // ...中略...
    function sendLocation() {
        navigator.geolocation.getCurrentPosition((pos) => {
            db.collection("locations").doc(myId).set({
                lat: pos.coords.latitude, 
                lng: pos.coords.longitude, 
                name: myName,
                icon: myIconUrl, // 【追加】アイコンURLを送信
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { lastSuccessTime = Date.now(); });
            
            // 自分のアイコンも画像にする
            const customIcon = L.divIcon({
                className: 'custom-icon',
                html: `<div class="icon-circle" style="background-image: url(${myIconUrl});"></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            if (myMarker) {
                myMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
            } else {
                myMarker = L.marker([pos.coords.latitude, pos.coords.longitude], {icon: customIcon})
                    .addTo(map)
                    .bindTooltip(myName, { permanent: true, direction: 'top', className: 'admin-label' });
            }
        }, (err) => console.log(err), { enableHighAccuracy: true });
    }
    sendLocation();
    updateInterval = setInterval(sendLocation, 10000);
}
</script>

<style>
/* 【追加】丸いアイコン用のスタイル */
.custom-icon { background: none; border: none; }
.icon-circle {
    width: 40px; height: 40px;
    border-radius: 50%;
    background-size: cover;
    background-position: center;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
</style>
