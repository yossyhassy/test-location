// Firebaseを監視して全員を表示
        db.collection("locations").onSnapshot((snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const data = change.doc.data();
                const id = change.doc.id;

                // --- 【ここがポイント】名前がない、または空文字のデータは無視する ---
                if (!data || !data.name || data.name.trim() === "") {
                    // もし名前が消されたデータが届いたら、地図から消す
                    if (markers[id]) {
                        map.removeLayer(markers[id]);
                        if (pathLayers[id]) map.removeLayer(pathLayers[id]);
                        delete markers[id];
                    }
                    return; 
                }
                // -------------------------------------------------------------

                const pos = [data.lat, data.lng];

                if (change.type === "added" || change.type === "modified") {
                    // 足跡の更新
                    if (!userPaths[id]) userPaths[id] = [];
                    userPaths[id].push(pos);

                    if (pathLayers[id]) {
                        pathLayers[id].setLatLngs(userPaths[id]);
                    } else {
                        const color = (id === myId) ? 'blue' : 'red';
                        pathLayers[id] = L.polyline(userPaths[id], {color: color, weight: 3, opacity: 0.6});
                        if (showPath) pathLayers[id].addTo(map);
                    }

                    // マーカーの更新
                    const label = data.name + (id === myId ? " (自分)" : "");
                    if (markers[id]) {
                        markers[id].setLatLng(pos).getPopup().setContent(label);
                    } else {
                        const icon = (id === myId) ? blueIcon : redIcon;
                        markers[id] = L.marker(pos, {icon: icon}).addTo(map).bindPopup(label);
                    }
                }
                
                // データが削除された場合は地図から消す
                if (change.type === "removed") {
                    if (markers[id]) {
                        map.removeLayer(markers[id]);
                        delete markers[id];
                    }
                    if (pathLayers[id]) {
                        map.removeLayer(pathLayers[id]);
                        delete pathLayers[id];
                    }
                }
            });
        });
