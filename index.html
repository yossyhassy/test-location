<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>現在地共有マップ（DBクリーンアップ版）</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* 左上の管理者追跡メニュー */
        #admin-menu {
            position: fixed; top: 10px; left: 10px;
            z-index: 2000; display: flex; flex-direction: column; gap: 8px;
            max-width: 200px;
        }
        .menu-title {
            background: #333; color: white; padding: 8px 12px;
            font-size: 12px; border-radius: 5px; font-weight: bold; text-align: center;
        }
        .user-btn {
            background: white; border: 2px solid #007bff; border-radius: 5px;
            padding: 10px; font-size: 14px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s;
            text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .user-btn:hover { background: #f0f7ff; transform: translateX(5px); }

        /* 名前ラベル（常時表示） */
        .viewer-label { 
            background: white; border: 2px solid #007bff; border-radius: 5px; 
            padding: 2px 8px; font-weight: bold; white-space: nowrap; color: #333; 
        }
    </style>
</head>
<body>

    <div id="admin-menu">
        <div class="menu-title">管理者を追跡</div>
        <div id="button-list"></div>
    </div>

    <div id="map"></div>

    <script>
    // --- Firebase 設定 ---
    const firebaseConfig = {
        apiKey: "AIzaSyBUuwShytyJQcmTY0GohqiRa8-EinFCmqY",
        authDomain: "my-location-app-6812a.firebaseapp.com",
        projectId: "my-location-app-6812a",
        storageBucket: "my-location-app-6812a.firebasestorage.app",
        messagingSenderId: "123347808605",
        appId: "1:123347808605:web:bd806f38a25e5c9d0638b4"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- 地図の初期化 ---
    const map = L.map('map').setView([35.6895, 139.6917], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = {};
    const userPaths = {}; 
    const pathLayers = {};
    const lastUpdateTimes = {}; // ブラウザ側での生存確認用

    // 選択した管理者に移動する関数
    function focusUser(id) {
        if (markers[id]) {
            map.flyTo(markers[id].getLatLng(), 16);
            markers[id].openTooltip();
        }
    }

    // --- 【新機能】データベース(Firestore)の古いゴミを消去する関数 ---
    async function cleanupDatabase() {
        const now = new Date();
        const threshold = new Date(now.getTime() - 60000); // 60秒前

        try {
            // timestampが60秒以上前のドキュメントを取得
            const oldDocs = await db.collection("locations")
                .where("timestamp", "<", threshold)
                .get();

            const batch = db.batch();
            oldDocs.forEach(doc => {
                batch.delete(doc.ref);
                console.log("DBから古いデータを掃除しました:", doc.id);
            });
            await batch.commit();
        } catch (e) {
            console.error("DBクリーンアップ失敗（権限不足の可能性があります）:", e);
        }
    }

    // 足跡消去タイマー（30秒）
    setInterval(() => {
        const now = Date.now();
        for (let id in userPaths) {
            userPaths[id] = userPaths[id].filter(p => (now - p.time) < 30000);
            if (pathLayers[id]) {
                const latlngs = userPaths[id].map(p => p.pos);
                pathLayers[id].setLatLngs(latlngs);
                if (latlngs.length < 2) map.removeLayer(pathLayers[id]);
            }
        }
    }, 3000);

    // 生存チェックタイマー（10秒ごとにUIから消去 & DBお掃除）
    setInterval(() => {
        const now = Date.now();
        for (let id in lastUpdateTimes) {
            if (now - lastUpdateTimes[id] > 60000) {
                removeUserUI(id);
                delete lastUpdateTimes[id];
            }
        }
        cleanupDatabase(); // ついでにDB側の掃除も実行
    }, 10000);

    // --- メイン監視処理 ---
    db.collection("locations").onSnapshot(snapshot => {
        const buttonList = document.getElementById('button-list');

        snapshot.docChanges().forEach(change => {
            const data = change.doc.data();
            const id = change.doc.id;

            // 削除された、または名前がないデータの処理
            if (!data || !data.name || change.type === "removed") {
                removeUserUI(id);
                delete lastUpdateTimes[id];
                return
